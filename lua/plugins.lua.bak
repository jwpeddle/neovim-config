require("packer").startup(function(use)
  --cmp - completion
  use({
    "hrsh7th/nvim-cmp",
    requires = {
      "neovim/nvim-lspconfig",
      "hrsh7th/cmp-nvim-lsp",
      "hrsh7th/cmp-buffer",
      "hrsh7th/cmp-path",
      "hrsh7th/cmp-cmdline",
      "L3MON4D3/LuaSnip",
      "saadparwaiz1/cmp_luasnip",
    },
    config = function()
      local has_words_before = function()
        local line, col = unpack(vim.api.nvim_win_get_cursor(0))
        return col ~= 0 and vim.api.nvim_buf_get_lines(0, line - 1, line, true)[1]:sub(col, col):match("%s") == nil
      end

      cmp.setup({
        completion = {
          autocomplete = false,
          completeopt = "menu,menuone,preview,noinsert",
        },

        mapping = {
          ["<Tab>"] = cmp.mapping(function(fallback)
            if cmp.visible() then
              cmp.select_next_item()
            elseif has_words_before() then
              cmp.complete({
                config = {
                  sources = {
                    { name = "nvim_lsp" },
                  }
                }
              })
            else
              fallback()
            end
          end, { "i", "s" }),
          ["<CR>"] = cmp.mapping(function(fallback)
            if cmp.visible() then
              cmp.confirm()
            else
              fallback()
            end
          end, { "i", "s" }),
        }
      })

    end
  })

  --treesitter-textobjects
  use({
    "nvim-treesitter/nvim-treesitter-textobjects",
    config = function()
      require("nvim-treesitter.configs").setup({})
    end
  })

  --which-key - shortcut suggestions
  use({
    "folke/which-key.nvim",
    config = function()
      local wk = require("which-key")
      wk.setup()
      vim.opt.timeoutlen = 500

      --normal mode
      wk.register({
        --common
        ["<Leader>"] = {
          name = "+Prefix",
          o = { "<Cmd>lua require('telescope.builtin').find_files()<CR>", "Open file" },
          n = { "<Cmd>NvimTreeToggle<CR>", "Explore" },
          b = { "<Cmd>lua require('telescope.builtin').buffers()<CR>", "Buffers" },
          w = { "<Cmd>bwipeout<CR>", "Close buffer" },
          W = { "<Cmd>%bwipeout<CR>", "Close all buffers" },
          q = { "<Cmd>quit<cr>", "Quit" },
          s = { "<Cmd>AerialToggle<CR>", "Map" },
          y = { "<Cmd>lua require('telescope').extensions.yank_history.yank_history()<CR>", "Yank history" },
          u = { "<Cmd>lua require('telescope').extensions.undo.undo()<CR>", "Undos" },
          ["-"] = { "<Cmd>lua require('oil').open_float()<CR>", "Edit files" },
          ["<Tab>"] = { "<C-w>w", "Switch window" },
        },
        --diagnostics
        ["<Leader>d"] = {
          name = "+Diagnostics",
          d = { "<Cmd>TroubleToggle<cr>", "Toggle Trouble" },
          w = { "<Cmd>TroubleToggle workspace_diagnostics<CR>", "Workspace" },
          b = { "<Cmd>TroubleToggle document_diagnostics<CR>", "Buffer" },
          q = { "<Cmd>TroubleToggle quickfix<CR>", "Quickfix" },
          l = { "<Cmd>TroubleToggle loclist<CR>", "Location list" },
        },
        --find
        ["<Leader>f"] = {
          name = "+Telescope",
          d = { "<Cmd>lua require('telescope.builtin').lsp_definitions()<CR>", "Definition" },
          h = { "<Cmd>lua require('telescope.builtin').help_tags()<CR>", "Help" },
          g = { "<Cmd>lua require('telescope.builtin').live_grep()<CR>", "Search workspace" },
          e = { "<Cmd>lua require('telescope').extensions.file_browser.file_browser()<CR>", "Explore" },
          r = { "<Cmd>lua require('telescope.builtin').lsp_references()<CR>", "References" },
          s = { "<Cmd>lua require('telescope.builtin').lsp_document_symbols()<CR>", "Document symbols" },
          w = { "<Cmd>lua require('telescope.builtin').lsp_dynamic_workspace_symbols()<CR>", "Workspace symbols" },
          ["/"] = { "<Cmd>lua require('telescope.builtin').current_buffer_fuzzy_find()<CR>", "Search buffer" },
          ["?"] = { "<Cmd>lua require('telescope.builtin').builtin()<CR>", "Pickers" },
        },
        --git
        ["<Leader>g"] = {
          name = "+Git",
          b = { "<Cmd>Git blame<CR>", "Blame" },
          o = { "<Cmd>Gbrowse<CR>", "Github" },
        },
        --ai
        ["<Leader>a"] = {
          name = "+AI",
          p = { "<Cmd>ChatGPT<cr>", "Prompt" },
          a = { "<Cmd>lua require('chatgpt').edit_with_instructions()<CR>", "Edit", mode = {"n", "v"}},
          c = { "<Cmd>lua require('chatgpt').complete_code()<CR>", "Complete", mode = {"n", "v"}},
        },
        --neovim
        ["<Leader><Leader>"] = {
          name = "+Neovim",
          e = { "<Cmd>execute 'cd $NVIM_HOME'<CR><Cmd>edit $MYVIMRC<CR>", "Edit config" },
          r = { "<Cmd>Reload<CR>", "Reload config" },
          p = { "<Cmd>PackerSync<CR>", "Sync packages" },
          h = { "<Cmd>checkhealth<CR>", "Check health" },
        },
        --unleadered
        ["<Left>"] = { "<Cmd>BufferLineCyclePrev<CR>", "Previous buffer" },
        ["<Right>"] = { "<Cmd>BufferLineCycleNext<CR>", "Next buffer" },
        ["<C-Space>"] = { "<Cmd>FloatermToggle<CR>", "Open terminal" },
        ["<C-n>"] = { "<Plug>(YankyCycleForward)", "Next yank" },
        ["<C-p>"] = { "<Plug>(YankyCycleBackward)", "Previous yank" },
        p = { "<Plug>(YankyPutAfter)", "Put after" },
        P = { "<Plug>(YankyPutBefore)", "Put before" },
      })

      --terminal mode
      wk.register({
        ["<Esc>"] = { "<Cmd>FloatermToggle<CR>", "Close terminal" },
      }, {
        mode = "t",
      })
    end
  })

  --packer - plugin management
  use("wbthomason/packer.nvim")
end)
